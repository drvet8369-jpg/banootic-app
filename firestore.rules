rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Providers can be listed and read by anyone, but only the authenticated provider can write to their own document.
    match /providers/{providerId} {
      allow get, list: if true;
      allow write: if request.auth != null && request.auth.token.phone_number == providerId;
    }

    // Reviews can be listed and read by anyone, but only authenticated users can create them.
    match /reviews/{reviewId} {
      allow get, list: if true;
      allow create: if request.auth != null;
      allow update, delete: if false; // Reviews are immutable
    }

    // Agreements can only be read or written by authenticated users.
    // Further specific logic would be needed in backend functions for security.
    match /agreements/{agreementId} {
      allow read, write: if request.auth != null;
    }

    // A user can only access their own inbox document.
    match /inboxes/{userId} {
      allow read, write: if request.auth != null && request.auth.token.phone_number == userId;
    }

    // Messages can only be read/written by authenticated users who are members of the chat.
    // This relies on the inbox document having a map of chatIds for that user.
    match /chats/{chatId}/{message=**} {
       allow read, write: if request.auth != null && exists(/databases/$(database)/documents/inboxes/$(request.auth.token.phone_number)) && chatId in get(/databases/$(database)/documents/inboxes/$(request.auth.token.phone_number)).data;
    }
    
    // Settings collection is locked down.
    match /settings/{settingId} {
      allow read, write: if false;
    }
  }
}
