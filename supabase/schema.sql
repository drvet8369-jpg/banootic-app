-- Create categories table
CREATE TABLE categories (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL,
    slug TEXT NOT NULL UNIQUE,
    description TEXT
);

-- Create services table
CREATE TABLE services (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL,
    slug TEXT NOT NULL,
    category_id BIGINT REFERENCES categories(id) ON DELETE CASCADE,
    UNIQUE(slug, category_id)
);

-- Create profiles table
CREATE TABLE profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    account_type TEXT CHECK (account_type IN ('customer', 'provider')) NOT NULL,
    full_name TEXT,
    service_description TEXT,
    bio TEXT,
    location TEXT,
    phone TEXT,
    category_id BIGINT REFERENCES categories(id),
    service_id BIGINT REFERENCES services(id),
    rating NUMERIC,
    reviews_count INT,
    profile_image_url TEXT,
    portfolio_urls TEXT[]
);

-- Create reviews table
CREATE TABLE reviews (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    provider_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    author_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    author_name TEXT,
    rating INT CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create one_time_passwords table for OTP logic
CREATE TABLE one_time_passwords (
    phone TEXT PRIMARY KEY,
    token TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);


-- Function to update full_name, bio, etc., in a single text column for FTS
ALTER TABLE profiles ADD COLUMN fts tsvector
GENERATED ALWAYS AS (
    to_tsvector('english', coalesce(full_name, '') || ' ' || coalesce(service_description, '') || ' ' || coalesce(bio, ''))
) STORED;

-- Create an index for the fts column
CREATE INDEX profiles_fts_idx ON profiles USING GIN (fts);


-- Enable RLS for all tables
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE services ENABLE ROW LEVEL SECURITY;
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE reviews ENABLE ROW LEVEL SECURITY;
ALTER TABLE one_time_passwords ENABLE ROW LEVEL SECURITY;


-- Policies
-- Categories can be read by everyone.
CREATE POLICY "Allow public read access to categories"
ON categories FOR SELECT
USING (true);

-- Services can be read by everyone.
CREATE POLICY "Allow public read access to services"
ON services FOR SELECT
USING (true);

-- Profiles can be read by everyone.
CREATE POLICY "Allow public read access to profiles"
ON profiles FOR SELECT
USING (true);

-- Users can insert their own profile.
CREATE POLICY "Allow users to insert their own profile"
ON profiles FOR INSERT
WITH CHECK (auth.uid() = id);

-- Users can update their own profile.
CREATE POLICY "Allow users to update their own profile"
ON profiles FOR UPDATE
USING (auth.uid() = id);

-- Reviews can be read by everyone.
CREATE POLICY "Allow public read access to reviews"
ON reviews FOR SELECT
USING (true);

-- Authenticated users can insert reviews.
CREATE POLICY "Allow authenticated users to insert reviews"
ON reviews FOR INSERT
WITH CHECK (auth.role() = 'authenticated');

-- Users can delete their own reviews.
CREATE POLICY "Allow users to delete their own reviews"
ON reviews FOR DELETE
USING (auth.uid() = author_id);

-- One Time Passwords table should be admin-only from the client.
-- The admin client (using service_role key) bypasses RLS.
-- No policies are needed if client-side access is not required.
