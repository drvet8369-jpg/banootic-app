
-- Drop existing tables if they exist to start fresh
drop table if exists "reviews" cascade;
drop table if exists "portfolio_items" cascade;
drop table if exists "providers" cascade;
drop table if exists "profiles" cascade;
drop table if exists "one_time_passwords" cascade;

-- Create the one_time_passwords table
create table public.one_time_passwords (
  id bigint generated by default as identity primary key,
  phone text not null unique,
  token text not null,
  created_at timestamptz not null default now()
);
comment on table public.one_time_passwords is 'Stores OTPs for phone verification.';
-- No RLS needed for this table as it's only accessed by admin/service_role.

-- Create the profiles table
create table public.profiles (
  id uuid not null primary key references auth.users on delete cascade,
  updated_at timestamptz,
  full_name text,
  phone text unique,
  account_type text default 'customer'::text
);
comment on table public.profiles is 'Profile information for all users.';

-- Create the providers table
create table public.providers (
  id bigint generated by default as identity primary key,
  profile_id uuid not null references public.profiles on delete cascade,
  name text not null,
  service text,
  location text,
  phone text unique,
  bio text,
  category_slug text,
  service_slug text,
  rating numeric(2,1) default 0.0,
  reviews_count integer default 0,
  profile_image jsonb,
  created_at timestamptz default now()
);
comment on table public.providers is 'Stores information about service providers.';

-- Create the portfolio_items table
create table public.portfolio_items (
  id bigint generated by default as identity primary key,
  provider_id bigint not null references public.providers on delete cascade,
  image_url text not null,
  ai_hint text,
  created_at timestamptz default now()
);
comment on table public.portfolio_items is 'Stores portfolio images for providers.';


-- Create the reviews table
create table public.reviews (
  id bigint generated by default as identity primary key,
  provider_id bigint not null references public.providers on delete cascade,
  author_id uuid references public.profiles on delete set null,
  author_name text not null,
  rating integer not null check (rating >= 1 and rating <= 5),
  comment text not null,
  created_at timestamptz not null default now()
);
comment on table public.reviews is 'Stores reviews and ratings for providers.';


-- Set up Row Level Security (RLS)
alter table public.profiles enable row level security;
alter table public.providers enable row level security;
alter table public.reviews enable row level security;
alter table public.portfolio_items enable row level security;

-- ** POLICIES **

-- Profiles Table Policies
create policy "Allow public read access to profiles" on public.profiles for select using (true);
create policy "Users can update their own profile" on public.profiles for update using (auth.uid() = id) with check (auth.uid() = id);
create policy "Allow full access for service_role" on public.profiles for all using ( (select auth.uid()) IS NOT NULL );

-- Providers Table Policies
create policy "Allow public read access to providers" on public.providers for select using (true);
create policy "Providers can update their own provider record" on public.providers for update using (auth.uid() = profile_id) with check (auth.uid() = profile_id);
create policy "Allow full access for service_role" on public.providers for all using ( (select auth.uid()) IS NOT NULL );

-- Reviews Table Policies
create policy "Allow public read access to reviews" on public.reviews for select using (true);
create policy "Authenticated users can insert reviews" on public.reviews for insert with check (auth.uid() is not null);
create policy "Users can delete their own reviews" on public.reviews for delete using (auth.uid() = author_id);
create policy "Allow full access for service_role" on public.reviews for all using ( (select auth.uid()) IS NOT NULL );

-- Portfolio Items Table Policies
create policy "Allow public read access to portfolio items" on public.portfolio_items for select using (true);
create policy "Providers can manage their own portfolio items" on public.portfolio_items for all using (exists (select 1 from providers where providers.id = portfolio_items.provider_id and providers.profile_id = auth.uid()));
create policy "Allow full access for service_role" on public.portfolio_items for all using ( (select auth.uid()) IS NOT NULL );
