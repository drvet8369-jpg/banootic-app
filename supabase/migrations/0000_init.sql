-- Create a custom type for user account types to ensure data integrity.
CREATE TYPE public.user_account_type AS ENUM ('provider', 'customer');

-- Create the main 'users' table to store basic information for all users.
-- This table is linked to Supabase's internal 'auth.users' table.
CREATE TABLE public.users (
    id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    phone TEXT NOT NULL UNIQUE,
    account_type public.user_account_type NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Create the 'providers' table for users who offer services.
CREATE TABLE public.providers (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    phone TEXT NOT NULL UNIQUE,
    service TEXT NOT NULL,
    location TEXT NOT NULL,
    bio TEXT NOT NULL,
    category_slug TEXT NOT NULL,
    service_slug TEXT NOT NULL,
    rating REAL NOT NULL DEFAULT 0,
    reviews_count INT NOT NULL DEFAULT 0,
    profile_image JSONB,
    portfolio JSONB[],
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Create the 'customers' table for users who consume services.
-- While simpler, this structure allows for future customer-specific fields.
CREATE TABLE public.customers (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Create the 'reviews' table for customer feedback.
CREATE TABLE public.reviews (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    provider_id BIGINT NOT NULL REFERENCES public.providers(id) ON DELETE CASCADE,
    customer_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    rating INT NOT NULL CHECK (rating >= 1 AND rating <= 5),
    comment TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    customer_name TEXT NOT NULL
);
