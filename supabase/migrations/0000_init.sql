
-- Create the 'users' table which will be publicly accessible
CREATE TABLE public.users (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    phone VARCHAR(20) UNIQUE NOT NULL,
    account_type TEXT NOT NULL CHECK (account_type IN ('customer', 'provider')),
    created_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

-- Enable Row Level Security for the 'users' table
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;

-- Policies for 'users' table
CREATE POLICY "Public users are viewable by everyone."
    ON public.users FOR SELECT
    USING (true);

CREATE POLICY "Users can insert their own profile."
    ON public.users FOR INSERT
    WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update their own profile."
    ON public.users FOR UPDATE
    USING (auth.uid() = id)
    WITH CHECK (auth.uid() = id);

-- Create the 'providers' table
CREATE TABLE public.providers (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID UNIQUE NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    phone VARCHAR(20) UNIQUE NOT NULL,
    service TEXT NOT NULL,
    location TEXT NOT NULL,
    bio TEXT,
    category_slug TEXT NOT NULL,
    service_slug TEXT NOT NULL,
    rating NUMERIC(2, 1) DEFAULT 0.0 NOT NULL,
    reviews_count INT DEFAULT 0 NOT NULL,
    profile_image JSONB,
    portfolio JSONB,
    created_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

-- Enable Row Level Security for the 'providers' table
ALTER TABLE public.providers ENABLE ROW LEVEL SECURITY;

-- Policies for 'providers' table
CREATE POLICY "Providers are viewable by everyone."
    ON public.providers FOR SELECT
    USING (true);

CREATE POLICY "Providers can insert their own profile."
    ON public.providers FOR INSERT
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Providers can update their own profile."
    ON public.providers FOR UPDATE
    USING (auth.uid() = user_id)
    WITH CHECK (auth.uid() = user_id);

-- Create the 'customers' table
CREATE TABLE public.customers (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID UNIQUE NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

-- Enable Row Level Security for the 'customers' table
ALTER TABLE public.customers ENABLE ROW LEVEL SECURITY;

-- Policies for 'customers' table
CREATE POLICY "Customers can view their own profile."
    ON public.customers FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY "Customers can insert their own profile."
    ON public.customers FOR INSERT
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Customers can update their own profile."
    ON public.customers FOR UPDATE
    USING (auth.uid() = user_id)
    WITH CHECK (auth.uid() = user_id);
