
-- Enable pgcrypto extension
create extension if not exists "pgcrypto" with schema "public";

-- Create custom types
create type "public"."account_type" as enum ('customer', 'provider');
create type "public"."agreement_status" as enum ('pending', 'confirmed');

-- Create tables
create table "public"."users" (
    "id" uuid not null,
    "name" character varying,
    "phone" character varying,
    "account_type" public.account_type,
    "created_at" timestamp with time zone not null default now()
);

alter table "public"."users" enable row level security;

create table "public"."providers" (
    "id" bigint generated by default as identity not null,
    "user_id" uuid not null,
    "name" character varying not null,
    "phone" character varying not null,
    "service" character varying not null,
    "location" character varying not null,
    "bio" text not null,
    "category_slug" character varying not null,
    "service_slug" character varying not null,
    "rating" real default '0'::real not null,
    "reviews_count" integer default 0 not null,
    "profile_image" jsonb,
    "portfolio" jsonb,
    "created_at" timestamp with time zone not null default now()
);

alter table "public"."providers" enable row level security;

create table "public"."reviews" (
    "id" bigint generated by default as identity not null,
    "provider_id" bigint not null,
    "customer_id" uuid not null,
    "rating" integer not null,
    "comment" text not null,
    "created_at" timestamp with time zone not null default now(),
    "customer_name" character varying not null
);

alter table "public"."reviews" enable row level security;

create table "public"."agreements" (
    "id" bigserial not null,
    "customer_phone" character varying not null,
    "provider_phone" character varying not null,
    "status" public.agreement_status default 'pending'::public.agreement_status not null,
    "requested_at" timestamp with time zone default now() not null,
    "confirmed_at" timestamp with time zone,
    constraint "agreements_pkey" primary key (id)
);

alter table "public"."agreements" enable row level security;


-- Set primary and foreign keys
ALTER TABLE ONLY "public"."providers"
    ADD CONSTRAINT "providers_pkey" PRIMARY KEY ("id");

ALTER TABLE ONLY "public"."providers"
    ADD CONSTRAINT "providers_user_id_fkey" FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;
    
ALTER TABLE ONLY "public"."providers"
    ADD CONSTRAINT "providers_phone_key" UNIQUE (phone);

ALTER TABLE ONLY "public"."reviews"
    ADD CONSTRAINT "reviews_pkey" PRIMARY KEY ("id");

ALTER TABLE ONLY "public"."reviews"
    ADD CONSTRAINT "reviews_customer_id_fkey" FOREIGN KEY (customer_id) REFERENCES public.users(id) ON DELETE CASCADE;

ALTER TABLE ONLY "public"."reviews"
    ADD CONSTRAINT "reviews_provider_id_fkey" FOREIGN KEY (provider_id) REFERENCES public.providers(id) ON DELETE CASCADE;

ALTER TABLE ONLY "public"."users"
    ADD CONSTRAINT "users_pkey" PRIMARY KEY ("id");

ALTER TABLE ONLY "public"."users"
    ADD CONSTRAINT "users_id_fkey" FOREIGN KEY (id) REFERENCES auth.users(id) ON DELETE CASCADE;

ALTER TABLE ONLY "public"."users"
    ADD CONSTRAINT "users_phone_key" UNIQUE (phone);


-- Create security policies
CREATE POLICY "Enable read access for all users" ON "public"."providers"
AS PERMISSIVE FOR SELECT
TO public
USING (true);

CREATE POLICY "Enable read access for all users" ON "public"."reviews"
AS PERMISSIVE FOR SELECT
TO public
USING (true);

CREATE POLICY "Enable insert for authenticated users" ON "public"."reviews"
AS PERMISSIVE FOR INSERT
TO authenticated
WITH CHECK (true);

CREATE POLICY "Users can insert their own profile" ON "public"."users"
AS PERMISSIVE FOR INSERT
TO public
WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can view their own profile" ON "public"."users"
AS PERMISSIVE FOR SELECT
TO public
USING (auth.uid() = id);

CREATE POLICY "Users can update their own profile" ON "public"."users"
AS PERMISSIVE FOR UPDATE
TO public
USING (auth.uid() = id)
WITH CHECK (auth.uid() = id);

CREATE POLICY "Allow authenticated user to create agreements" ON public.agreements FOR INSERT TO authenticated WITH CHECK (true);

CREATE POLICY "Users can view their own agreements" ON public.agreements FOR SELECT USING (
    (auth.jwt() ->> 'phone')::text = customer_phone OR (auth.jwt() ->> 'phone')::text = provider_phone
);

CREATE POLICY "Allow providers to update their agreements" ON public.agreements FOR UPDATE USING (
    (auth.jwt() ->> 'phone')::text = provider_phone
);
