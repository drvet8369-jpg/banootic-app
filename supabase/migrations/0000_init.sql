
-- Create custom types
create type public.user_account_type as enum ('provider', 'customer');

-- Create Users table
create table public.users (
  id uuid not null primary key default gen_random_uuid(),
  name text not null,
  phone text not null unique,
  account_type public.user_account_type not null,
  created_at timestamp with time zone not null default now()
);
comment on table public.users is 'Stores public user information.';

-- Create Providers table
create table public.providers (
  id bigint generated by default as identity primary key,
  user_id uuid not null references public.users(id) on delete cascade,
  name text not null,
  phone text not null unique,
  service text not null,
  location text not null,
  bio text not null,
  category_slug text not null,
  service_slug text not null,
  rating numeric(2, 1) not null default 0.0 check (rating >= 0 and rating <= 5),
  reviews_count integer not null default 0,
  profile_image jsonb,
  portfolio jsonb[],
  created_at timestamp with time zone not null default now()
);
comment on table public.providers is 'Stores information about service providers.';
alter table public.providers enable row level security;


-- Create Customers table
create table public.customers (
  id bigint generated by default as identity primary key,
  user_id uuid not null references public.users(id) on delete cascade,
  created_at timestamp with time zone not null default now()
);
comment on table public.customers is 'Stores information about customers.';
alter table public.customers enable row level security;


-- Create Reviews table
create table public.reviews (
  id bigint generated by default as identity primary key,
  provider_id bigint not null references public.providers(id) on delete cascade,
  customer_id uuid not null references public.users(id) on delete cascade,
  customer_name text not null,
  rating integer not null check (rating >= 1 and rating <= 5),
  comment text not null,
  created_at timestamp with time zone not null default now()
);
comment on table public.reviews is 'Stores reviews from customers for providers.';
alter table public.reviews enable row level security;


-- Create Conversations table
create table public.conversations (
    id uuid not null primary key default gen_random_uuid(),
    participant_one_id uuid not null references public.users(id) on delete cascade,
    participant_two_id uuid not null references public.users(id) on delete cascade,
    last_message_at timestamp with time zone,
    created_at timestamp with time zone not null default now(),
    unique(participant_one_id, participant_two_id)
);
comment on table public.conversations is 'Stores chat conversations between two users.';
alter table public.conversations enable row level security;

-- Create Messages table
create table public.messages (
    id uuid not null primary key default gen_random_uuid(),
    conversation_id uuid not null references public.conversations(id) on delete cascade,
    sender_id uuid not null references public.users(id) on delete cascade,
    receiver_id uuid not null references public.users(id) on delete cascade,
    content text not null,
    is_read boolean not null default false,
    created_at timestamp with time zone not null default now()
);
comment on table public.messages is 'Stores individual chat messages within a conversation.';
alter table public.messages enable row level security;
