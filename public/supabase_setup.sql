-- supabase_setup.sql

-- 1. Create Users Table
-- This table stores central user information.
create table if not exists
  public.users (
    id uuid not null primary key default gen_random_uuid (),
    created_at timestamp with time zone not null default now(),
    name character varying not null,
    account_type text not null,
    phone character varying not null,
    constraint users_phone_key unique (phone)
  );
comment on table public.users is 'Central table for all application users.';

-- Enable RLS for the users table
alter table public.users enable row level security;

-- Allow anonymous users to read from the users table (CRUCIAL FOR LOGIN)
create policy "Allow anonymous read access on users" on public.users
  for select
  using (true);

-- 2. Create Providers Table
-- This table stores detailed information for service providers.
create table if not exists
  public.providers (
    id uuid not null primary key default gen_random_uuid (),
    user_id uuid not null,
    created_at timestamp with time zone not null default now(),
    name character varying not null,
    service character varying not null,
    location character varying not null,
    phone character varying not null,
    bio text not null,
    category_slug text not null,
    service_slug text not null,
    rating real not null default 0,
    reviews_count integer not null default 0,
    profile_image jsonb null,
    portfolio jsonb[] null,
    constraint providers_phone_key unique (phone),
    constraint providers_user_id_fkey foreign key (user_id) references users (id) on delete cascade
  );
comment on table public.providers is 'Profiles for service providers.';
alter table public.providers enable row level security;
create policy "Allow public read access on providers" on public.providers for select using (true);
create policy "Allow provider to update their own profile" on public.providers for update using (auth.uid() = user_id);

-- 3. Create Customers Table
-- This table stores information for customers.
create table if not exists
  public.customers (
    id uuid not null primary key default gen_random_uuid (),
    user_id uuid not null,
    created_at timestamp with time zone not null default now(),
    name character varying not null,
    phone character varying not null,
    constraint customers_phone_key unique (phone),
    constraint customers_user_id_fkey foreign key (user_id) references users (id) on delete cascade
  );
comment on table public.customers is 'Profiles for customers.';
alter table public.customers enable row level security;
create policy "Allow public read access on customers" on public.customers for select using (true);

-- 4. Create Reviews Table
-- This table stores reviews left by customers for providers.
create table if not exists
  public.reviews (
    id bigint generated by default as identity,
    created_at timestamp with time zone not null default now(),
    provider_id uuid not null,
    user_id uuid null,
    author_name character varying not null,
    rating real not null,
    comment text not null,
    constraint reviews_pkey primary key (id),
    constraint reviews_provider_id_fkey foreign key (provider_id) references providers (id) on delete cascade,
    constraint reviews_user_id_fkey foreign key (user_id) references users (id) on delete set null
  );
comment on table public.reviews is 'Customer reviews for providers.';
alter table public.reviews enable row level security;
create policy "Allow public read access on reviews" on public.reviews for select using (true);
create policy "Allow authenticated users to insert reviews" on public.reviews for insert with check (auth.role() = 'authenticated');

-- 5. Create Agreements Table
-- Tracks agreements between customers and providers.
create table if not exists
  public.agreements (
    id bigint generated by default as identity,
    requested_at timestamp with time zone not null default now(),
    provider_id uuid not null,
    customer_id uuid not null,
    status text not null default 'pending'::text,
    confirmed_at timestamp with time zone null,
    provider_phone character varying not null,
    customer_phone character varying not null,
    customer_name character varying not null,
    constraint agreements_pkey primary key (id),
    constraint agreements_customer_id_fkey foreign key (customer_id) references users (id) on delete cascade,
    constraint agreements_provider_id_fkey foreign key (provider_id) references providers (id) on delete cascade,
    constraint agreements_provider_id_customer_id_key unique (provider_id, customer_id)
  );
comment on table public.agreements is 'Records agreements between customers and providers.';
alter table public.agreements enable row level security;
create policy "Allow users to see their own agreements" on public.agreements for select using (auth.uid() = customer_id or auth.uid() = (select user_id from providers where id = provider_id));
create policy "Allow customers to create agreements" on public.agreements for insert with check (auth.uid() = customer_id and auth.role() = 'authenticated');
create policy "Allow providers to update agreements" on public.agreements for update using (auth.uid() = (select user_id from providers where id = provider_id));


-- 6. Create Messages Table
-- Stores chat messages between users.
create table if not exists
  public.messages (
    id bigint generated by default as identity,
    created_at timestamp with time zone not null default now(),
    chat_id text not null,
    sender_id uuid not null,
    receiver_id uuid not null,
    content text not null,
    constraint messages_pkey primary key (id),
    constraint messages_receiver_id_fkey foreign key (receiver_id) references users (id) on delete cascade,
    constraint messages_sender_id_fkey foreign key (sender_id) references users (id) on delete cascade
  );
comment on table public.messages is 'Chat messages between users.';
alter table public.messages enable row level security;
create policy "Allow users to read messages in their chats" on public.messages for select using (auth.uid() = sender_id or auth.uid() = receiver_id);
create policy "Allow users to send messages" on public.messages for insert with check (auth.uid() = sender_id);


-- 7. Create Storage Bucket for Images
-- Ensure the 'images' bucket exists.
insert into
  storage.buckets (id, name, public)
values
  ('images', 'images', true)
on conflict (id) do nothing;
comment on table storage.buckets is 'Storage for public images like profiles and portfolios.';
create policy "Allow public read access on images" on storage.objects for select using ( bucket_id = 'images' );
create policy "Allow authenticated users to upload images" on storage.objects for insert with check ( bucket_id = 'images' and auth.role() = 'authenticated' );


-- 8. Create RPC Function to get user conversations
-- This function simplifies fetching a user's conversation list.
drop function if exists get_user_conversations(uuid);
create function get_user_conversations (p_user_id uuid)
returns table (
  chat_id text,
  other_user_id uuid,
  other_user_name character varying,
  other_user_avatar text,
  other_user_phone character varying,
  last_message_content text,
  last_message_at timestamp with time zone
)
language sql
as $$
  with last_messages as (
    select
      chat_id,
      max(created_at) as max_created_at
    from messages
    where sender_id = p_user_id or receiver_id = p_user_id
    group by chat_id
  )
  select
    m.chat_id,
    case
      when m.sender_id = p_user_id then m.receiver_id
      else m.sender_id
    end as other_user_id,
    u.name as other_user_name,
    coalesce(p.profile_image->>'src', c.profile_image->>'src', null) as other_user_avatar,
    u.phone as other_user_phone,
    m.content as last_message_content,
    m.created_at as last_message_at
  from messages m
  join last_messages lm on m.chat_id = lm.chat_id and m.created_at = lm.max_created_at
  join users u on u.id = (case when m.sender_id = p_user_id then m.receiver_id else m.sender_id end)
  left join providers p on p.user_id = u.id
  left join customers c on c.user_id = u.id
  order by m.created_at desc;
$$;
comment on function public.get_user_conversations(p_user_id uuid) is 'Fetches a user''s conversation list with the last message for each.';
